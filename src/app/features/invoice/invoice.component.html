<div class="mobile-wrapper" [class.dark-mode]="themeService.darkMode()">
  <header class="address-header">
    <h1 class="city-title">{{ intervention()?.adresse?.ville }}</h1>
    <span class="street-detail">{{ intervention()?.adresse?.numero }} {{ intervention()?.adresse?.rue }}</span>
  </header>

  <main class="container">
    @if (!loading() && intervention()) {
      
      <section class="section">
        <h3 class="title">Contacts</h3>
        <div class="generic-card">
          @if (intervention()?.proprietaire; as p) {
            <div class="row contact">
              <span class="icon">üë§</span>
              <div class="content">
                <span class="label">{{ p.prenom }} {{ p.nom }}</span>
                <span class="status">PROPRI√âTAIRE</span>
              </div>
              <a [href]="'tel:'+p.tel" class="tel-link">Appeler</a>
            </div>
          }
          @for (h of intervention()?.habitants; track $index) {
            <div class="row contact">
              <span class="icon">üè†</span>
              <div class="content">
                <span class="label">{{ h.prenom }} {{ h.nom }}</span>
                <span class="status">HABITANT</span>
              </div>
              <a [href]="'tel:'+h.tel" class="tel-link">Appeler</a>
            </div>
          }
        </div>
      </section>

      <section class="section">
        <h3 class="title">D√©tail des Travaux</h3>
        <div class="generic-card">
          @for (task of intervention()?.tasks; track $index) {
            <div class="row task" [class.done]="task.done">
              <span class="icon">{{ task.done ? '‚úì' : '‚óã' }}</span>
              <div class="content">
                <span class="label">{{ task.label }}</span>
              </div>
              <span class="status-badge">{{ task.done ? 'EFFECTU√â' : 'NON R√âALIS√â' }}</span>
            </div>
          }
        </div>
      </section>

      <section class="section">
        <h3 class="title">Main d'≈ìuvre & Frais</h3>
        <div class="generic-card">
          @for (s of intervention()?.timeSessions; track s.id) {
            <div class="row price">
              <div class="content">
                <span class="label">{{ s.date | date:'dd/MM' }} ({{ s.workDuration }})</span>
              </div>
              <div class="input-box" [class.saving]="savingId() === s.id.toString()">
                <input [readonly]="!canEditPrice()" 
                       type="number" step="0.01" [value]="s.price" 
                       (change)="updateItemPrice('timeSessions', s.id, $any($event.target).value)">
                <span class="eur">‚Ç¨</span>
              </div>
            </div>
          }
          <div class="row price">
            <div class="content"><span class="label">{{ travelLabel() }}</span></div>
            <div class="input-box" [class.saving]="savingId() === 'travelCost'">
              <input [readonly]="!canEditPrice()" 
                     type="number" step="0.01" [value]="intervention()?.travelCost" 
                     (change)="updateSingleField('travelCost', $any($event.target).value)">
              <span class="eur">‚Ç¨</span>
            </div>
          </div>
        </div>
      </section>

      <section class="section">
        <h3 class="title">Mat√©riel & Fournitures</h3>
        <div class="generic-card">
          @for (m of intervention()?.materials; track m.id) {
            <div class="row price">
              <div class="content"><span class="label">{{ m.description }}</span></div>
              <div class="input-box" [class.saving]="savingId() === m.id.toString()">
                <input [readonly]="!canEditPrice()" 
                       type="number" step="0.01" [value]="m.price" 
                       (change)="updateItemPrice('materials', m.id, $any($event.target).value)">
                <span class="eur">‚Ç¨</span>
              </div>
            </div>
          }
        </div>
      </section>

  <button class="total-button-action" 
        [class.is-billed]="intervention()?.status === 'BILLED'"
        (click)="sendNotification()" 
        [disabled]="loading() || intervention()?.status === 'BILLED' || isSendingEmail()">
  
  <div class="left-side">
    <span class="action-label">
      @if (isSendingEmail()) {
        Notification en cours...
      } @else {
        {{ intervention()?.status === 'BILLED' ? 'Paiement d√©j√† notifi√©' : 'Cliquer pour notifier le paiement' }}
      }
    </span>
  </div>

  <div class="right-side">
    @if (isSendingEmail()) {
      <div class="loader"></div>
    } @else {
      <span class="total-amount">{{ grandTotal() | number:'1.2-2' }}‚Ç¨</span>
    }
  </div>
</button>
    }
  </main>

  <nav class="bottom-nav">
    <button class="nav-item" (click)="goBack()">
       <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
      <span>Accueil</span>
    </button>
  </nav>

  @if (showNotificationModal()) {
    <app-notification-modal 
      [email]="assignedName()"
      (confirm)="handleNotificationConfirmation($event)"
      (close)="showNotificationModal.set(false)">
    </app-notification-modal>
  }
</div>