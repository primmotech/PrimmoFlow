<div class="mobile-wrapper" [class.dark-mode]="theme.darkMode()">

    <header class="app-header-large">
        <div class="header-top"></div>

        @if (targetIntervention()) {
        <div class="intervention-summary-card" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div class="address-details">
                <span class="city">{{ targetIntervention().adresse.ville }}</span>
                <span class="street-line">
                    {{ targetIntervention().adresse.numero }} {{ targetIntervention().adresse.rue }}
                </span>
            </div>

<div class="contact-zone">
    <div class="habitant-pill" (click)="switchHabitant()">
        <span>{{ targetIntervention().habitants[selectedHabitantIndex()].nom }}</span>
        @if (targetIntervention().habitants.length > 1) { <small>⇄</small> }
    </div>
    
    <a [href]="'tel:' + targetIntervention().habitants[selectedHabitantIndex()].telephone" class="btn-call-retro">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18.5 9c1.5 0 2.5-1 2.5-2.5S20 4 18.5 4c-1.5 0-3.5 1-6.5 1s-5-1-6.5-1C4 4 3 5 3 6.5S4 9 5.5 9" />
            <path d="M7 7.5c1.5 0 3 .5 5 .5s3.5-.5 5-.5" />
            <path d="M5 12h14l2 8H3l2-8z" />
            <circle cx="12" cy="16" r="2.5" />
        </svg>
    </a>
</div>
        </div>
        }
    </header>

@if (targetIntervention()?.mission?.length) {
  <section class="mission-tasks-list">
    <ul class="tasks-container">
      @for (task of targetIntervention().mission; track $index) {
        <li class="task-row">
          <div class="bullet"></div>
          <div class="task-text">{{ task }}</div>
        </li>
      }
    </ul>
  </section>
}

    <main class="container">
        <section class="calendar-card">
            <div class="nav">
                <button (click)="changeMonth(-1)">‹</button>
                <h2 class="capitalize">{{ viewDate() | date:'MMMM yyyy':'':'fr' }}</h2>
                <button (click)="changeMonth(1)">›</button>
            </div>
            <div class="grid">
                @for (dayName of ['L','M','M','J','V','S','D']; track dayName) { <div class="label">{{dayName}}</div> }
                @for (day of daysInMonth(); track $index) {
                <div class="day-container">
                    <div class="day" 
                         [class.empty]="!day" 
                         [class.past]="isPast(day)" 
                         [class.selected]="isSelected(day)"
                         [class.today]="isToday(day)" 
                         (click)="selectDate(day)">
                        {{ day | date:'d' }}
                    </div>
                    <div class="dots-container">
                        @for (m of getMissionsForDay(day); track m.id) {
                            <span [class.red-dot]="m.id !== targetIntervention()?.id" 
                                  [class.green-dot]="m.id === targetIntervention()?.id"></span>
                        }
                    </div>
                </div>
                }
            </div>
        </section>

        @if (selectedDate() && targetIntervention()) {
        <section class="planning-action">
            <button class="btn-plan" (click)="confirmPlanning()" [disabled]="isSubmitting()">
                @if (isSubmitting()) { <span>Enregistrement...</span> }
                @else { 
                    Planifier le {{ selectedDate() | date:'dd' }} 
                    <span class="capitalize">{{ selectedDate() | date:'MMMM':'':'fr' }}</span>
                }
            </button>
        </section>
        }

        <section class="daily-missions">
            <h3 class="section-title">
                Missions du {{ selectedDate() | date:'dd MMMM' }}
            </h3>

<div class="mission-list">
  @for (m of getMissionsForDay(selectedDate()); track m.id || $index) {
    <div class="mission-item-mini clickable" (click)="loadMissionToEdit(m)">
      <div class="time-pill">{{ m.displayHeure }}</div>
      
      <div class="info">
        <span class="city-main">{{ m.displayVille }}</span>
        <span class="address-sub">{{ m.displayNumero }} {{ m.displayRue }}</span>
      </div>

      <div class="edit-action">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      </div>
    </div>
  } @empty {
    <div class="no-mission">
      <p>Aucune intervention prévue ce jour</p>
    </div>
  }
</div>
        </section>
    </main>

    <nav class="bottom-nav">
        <a class="nav-item" (click)="goBack()">
   
       <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
      <span>Accueil</span>
    </a>
    </nav>

    @if (showTimePicker()) {
    <div class="modal-overlay">
        <div class="time-modal large">
            <div class="clock-circle-large">
                <svg width="280" height="280" viewBox="0 0 280 280" (click)="updateClock($event)">
                    <circle cx="140" cy="140" r="135" fill="var(--card-bg)" />
                    
                    @let h = selectedHour(); @let min = selectedMinute();
                    @let isInner = !pickingMinutes() && (h > 12 || h === 0);
                    @let r = pickingMinutes() ? 110 : (isInner ? 75 : 115);
                    @let angle = pickingMinutes() ? min * 6 : h * 30;

                    <line x1="140" y1="140" 
                         [attr.x2]="140 + r * Math.sin(angle * Math.PI / 180)"
                         [attr.y2]="140 - r * Math.cos(angle * Math.PI / 180)" 
                         stroke="var(--accent-color, #3498db)"
                         stroke-width="4" />
                    
                    <circle [attr.cx]="140 + r * Math.sin(angle * Math.PI / 180)"
                            [attr.cy]="140 - r * Math.cos(angle * Math.PI / 180)" 
                            r="22" fill="var(--accent-color, #3498db)" />

                    @if (!pickingMinutes()) {
                        @for (v of [12,1,2,3,4,5,6,7,8,9,10,11]; track v) {
                        <text [attr.x]="140 + 115 * Math.sin($index * 30 * Math.PI / 180)"
                              [attr.y]="140 - 115 * Math.cos($index * 30 * Math.PI / 180)" 
                              class="clock-label">{{v}}</text>
                        }
                        @for (v of [0,13,14,15,16,17,18,19,20,21,22,23]; track v) {
                        <text [attr.x]="140 + 75 * Math.sin($index * 30 * Math.PI / 180)"
                              [attr.y]="140 - 75 * Math.cos($index * 30 * Math.PI / 180)" 
                              class="clock-label small">{{ v === 0 ? '00' : v }}</text>
                        }
                    } @else {
                        @for (v of [0,5,10,15,20,25,30,35,40,45,50,55]; track v) {
                        <text [attr.x]="140 + 110 * Math.sin($index * 30 * Math.PI / 180)"
                              [attr.y]="140 - 110 * Math.cos($index * 30 * Math.PI / 180)" 
                              class="clock-label">{{ v | number:'2.0' }}</text>
                        }
                    }
                </svg>
            </div>
            
            <div class="time-display">
                <span [class.active]="!pickingMinutes()" (click)="pickingMinutes.set(false)">
                    {{ selectedHour() | number:'2.0' }}
                </span>:
                <span [class.active]="pickingMinutes()" (click)="pickingMinutes.set(true)">
                    {{ selectedMinute() | number:'2.0' }}
                </span>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel-clock" (click)="cancelTimeSelection()">Annuler</button>
                <button class="btn-save-clock" (click)="finalValidation()">Valider</button>
            </div>
        </div>
    </div>
    }
</div>