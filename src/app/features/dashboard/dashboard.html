<div class="mobile-wrapper" [class.dark-mode]="themeService.darkMode()">

  <header class="app-header">
    <div class="brand">
      <h1>PrimmoFlow</h1>
    </div>
    <div class="header-user"><span class="username">{{ authService.userNickName() }}</span></div>
  </header>

  @if (isOffline()) { <div class="offline-indicator">Vous êtes hors ligne.</div> }

<main class="container">
<app-dashboard-filters 
  [activeFilter]="activeFilter()" 
  [totalCount]="interventions().length"
  (filterChange)="setFilter($event)">
</app-dashboard-filters>

  @if (showPending()) {
    <section class="recent-activity">
      <h3>En Attente ({{ pendingInterventions().length }})</h3>
      <div class="intervention-list">
        @for (inter of pendingInterventions(); track inter.id) {
          <app-intervention-card 
            [intervention]="inter"
            (edit)="goToEdit($event)"
            (cardClick)="handleCardClick(inter, 'details')"
            (actionClick)="openTasks(inter, $event)">
          </app-intervention-card>
        }
      </div>
    </section>
  }

  @if (showPlanned()) {
    <section class="recent-activity">
      <h3>Planifiées ({{ plannedInterventions().length }})</h3>
      <div class="intervention-list">
        @for (inter of plannedInterventions(); track inter.id) {
          <app-intervention-card 
            [intervention]="inter"
            (edit)="goToEdit($event)"
            (cardClick)="handleCardClick(inter, 'details')"
            (actionClick)="authService.hasPerm('dash_act_plan') ? goToPlanning(inter, $event) : $event.stopPropagation()">
          </app-intervention-card>
        }
      </div>
    </section>
  }

  @if (showCompleted()) {
    <section class="recent-activity">
      <h3>Terminées ({{ completedInterventions().length }})</h3>
      <div class="intervention-list">
        @for (inter of completedInterventions(); track inter.id) {
          <app-intervention-card 
            [intervention]="inter"
            (cardClick)="handleCardClick(inter, 'invoice')"
            (actionClick)="handleCompletedClick(inter)">
          </app-intervention-card>
        }
      </div>
    </section>
  }

  @if (authService.hasPerm('dash_nav_add')) {
    <button class="fab-btn" (click)="goToAdd()">
      <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="white" stroke-width="3">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    </button>
  }
</main>

  <nav class="bottom-nav">
    @if (authService.hasPerm('dash_nav_orders')) {
    <a (click)="router.navigate(['/commandes'])" class="nav-item">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <path d="M16 10a4 4 0 0 1-8 0"></path>
      </svg>
      <span>Commandes</span>
    </a>
    }
    @if (authService.hasPerm('dash_nav_archives')) {
    <a (click)="goToCompletedMissions()" class="nav-item">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
      </svg>
      <span>Archives</span>
    </a>
    }
    @if (authService.hasPerm('dash_nav_params')) {
    <a (click)="router.navigate(['/parameters'])" class="nav-item">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
      <span>Paramètres</span>
    </a>
    }
    <a class="nav-item" (click)="authService.logout()">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#e74c3c" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
      <span style="color: #e74c3c;">Sortie</span>
    </a>
  </nav>
</div>

@if (selectedIntervention()) {
  <app-task-modal 
    [intervention]="selectedIntervention()!" 
    (close)="closeTasks()">
  </app-task-modal>
}