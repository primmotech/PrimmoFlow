<div class="mobile-wrapper" [class.dark-mode]="themeService.darkMode()">

  <app-header></app-header>

  <main class="container">

    <app-dashboard-filters [activeFilter]="activeFilter()" [totalCount]="filteredInterventions().length"
      [owners]="owners()" [selectedOwnerId]="selectedOwnerId()" (filterChange)="setFilter($event)"
      (ownerChange)="setOwnerFilter($event)">
    </app-dashboard-filters>

    @if (loading()) {
    <div class="loader-container">
      <div class="spinner"></div>
    </div>
    } @else {

    @if (showPending() && pendingInterventions().length > 0) {
    <section class="intervention-section">
      <h3 style="color:var(--section-waiting-color)">En attente ({{ pendingInterventions().length }})</h3>
      <div class="cards-grid">
        @for (inter of pendingInterventions(); track inter.id) {
        <app-intervention-card 
          [intervention]="inter"
          [showActionButton]="authService.hasPerm('dash_act_plan')"
          (deleteClick)="deleteIntervention($event)" 
          class="card-pending" 
 [style.--section-border-color]=" 'var(--section-waiting-color)' "
 [style.--status-color]="userProfiles()[inter.createdBy]?.color || '#49dd6b'"
          [statusConfig]="STATUS_CONFIG"
          [canDelete]="authService.hasPerm('dash_act_delete')"
          [canEdit]="authService.hasPerm('dash_act_edit')"
          (cardClick)="authService.hasPerm('dash_act_plan') ? goToPlanning(inter, $event) : openTasks(inter, $event)"
          (actionClick)="openTasks(inter, $event)"
          (action2Click)="router.navigate(['/history', inter.id]) "
          (editClick)="goToEdit(inter)"
          (callOwner)="makeCall($event)">
        </app-intervention-card>
        }
      </div>
    </section>
    }

    @if (showPlanned() && plannedInterventions().length > 0) {
    <section class="intervention-section">
      <h3 style="color:var(--section-planned-color)">Planifiées ({{ plannedInterventions().length }})</h3>
      <div class="cards-grid">
        @for (inter of plannedInterventions(); track inter.id) {
        <app-intervention-card 
          [intervention]="inter"
          (deleteClick)="deleteIntervention($event)"
          [canDelete]="authService.hasPerm('dash_act_delete')"
          class="card-planned" 
[style.--section-border-color]=" 'var(--section-planned-color)' "
 [style.--status-color]="userProfiles()[inter.createdBy]?.color || '#49dd6b'"
          [statusConfig]="STATUS_CONFIG"
          [canPlan]="authService.hasPerm('dash_act_plan')"
          [canEdit]="authService.hasPerm('dash_act_plan')"
          (editClick)="goToEdit(inter)"
          (cardClick)="goToDetails(inter)"
          (actionClick)="goToPlanning(inter, $event)"
          (callOwner)="makeCall($event)">
        </app-intervention-card>
        }
      </div>
    </section>
    }

@if (showCompleted() && completedInterventions().length > 0) {
    <section class="intervention-section">
      <h3 style="color:var(--section-end-color)">Terminées ({{ completedInterventions().length }})</h3>
      <div class="cards-grid">
        @for (inter of completedInterventions(); track inter.id) {
        <app-intervention-card 
          [intervention]="inter"
          class="card-completed" 
 [style.--section-border-color]=" 'var(--section-end-color)' "
  [style.--status-color]="userProfiles()[inter.createdBy]?.color || '#49dd6b'"
          [statusConfig]="STATUS_CONFIG"
          (deleteClick)="deleteIntervention($event)"
          [canDelete]="authService.hasPerm('dash_act_delete')"
          [canEdit]="authService.hasPerm('dash_act_plan')"
          (editClick)="goToEdit(inter)"
          (cardClick)="inter.status === 'END' ? goToInvoice(inter) : (inter.status === 'BILLED' && authService.hasPerm('dash_nav_billed') ? openPaymentModal(inter, $event) : null)"
          (actionClick)="inter.status === 'END' ? router.navigate(['/history', inter.id]) : null"
          (callOwner)="makeCall($event)">
        </app-intervention-card>
        }
      </div>
    </section>
    }

    @if (filteredInterventions().length === 0) {
    <div class="empty-state">
      <p>Aucune intervention trouvée</p>
    </div>
    }
    }
  </main>

  <app-bottom-nav></app-bottom-nav>

  @if (selectedIntervention()) {
  <app-task-modal 
  [intervention]="selectedIntervention()!" 
  (close)="selectedIntervention.set(null)"
  (callRequest)="makeCall($event)"
  (planRequest)="goToPlanning(selectedIntervention()); selectedIntervention.set(null)">

  </app-task-modal>
  }
  @if (selectedPaymentIntervention(); as inter) {
    <app-payment-modal 
      [address]="(inter.adresse.numero || '') + ' ' + (inter.adresse.rue || '') + ', ' + (inter.adresse.ville || '')"
      (close)="selectedPaymentIntervention.set(null)"
      (confirm)="confirmPayment($event)">
    </app-payment-modal>
  }
</div>