<div class="mobile-wrapper" [class.dark-mode]="themeService.darkMode()">

  <app-header></app-header>

  <main class="container">

    <app-dashboard-filters [activeFilter]="activeFilter()" [totalCount]="filteredInterventions().length"
      [owners]="owners()" [selectedOwnerId]="selectedOwnerId()" (filterChange)="setFilter($event)"
      (ownerChange)="setOwnerFilter($event)">
    </app-dashboard-filters>

    @if (loading()) {
    <div class="loader-container">
      <div class="spinner"></div>
    </div>
    } @else {

    @if (showPending() && pendingInterventions().length > 0) {
    <section class="intervention-section">
      <h2 class="section-title">En attente ({{ pendingInterventions().length }})</h2>
      <div class="cards-grid">
        @for (inter of pendingInterventions(); track inter.id) {
        <app-intervention-card 
          [intervention]="inter"
          (deleteClick)="deleteIntervention($event)" 
          [statusConfig]="STATUS_CONFIG"
          [canDelete]="authService.hasPerm('dash_act_delete')"
          [canEdit]="true"
          (cardClick)="goToPlanning(inter, $event)" 
          (actionClick)="openTasks(inter, $event)"
          (editClick)="goToEdit(inter)"
          (callOwner)="makeCall($event)">
        </app-intervention-card>
        }
      </div>
    </section>
    }

    @if (showPlanned() && plannedInterventions().length > 0) {
    <section class="intervention-section">
      <h2 class="section-title">Planifiées ({{ plannedInterventions().length }})</h2>
      <div class="cards-grid">
        @for (inter of plannedInterventions(); track inter.id) {
        <app-intervention-card 
          [intervention]="inter"
          (deleteClick)="deleteIntervention($event)"
          [canDelete]="authService.hasPerm('dash_act_delete')"
          [statusConfig]="STATUS_CONFIG"
          [canEdit]= "true"
          (editClick)="goToEdit(inter)"
          (cardClick)="goToDetails(inter)"
          (actionClick)="goToPlanning(inter, $event)"
          (callOwner)="makeCall($event)">
        </app-intervention-card>
        }
      </div>
    </section>
    }

    @if (showCompleted() && completedInterventions().length > 0) {
    <section class="intervention-section">
      <h2 class="section-title">Terminées ({{ completedInterventions().length }})</h2>
      <div class="cards-grid">
        @for (inter of completedInterventions(); track inter.id) {
        <app-intervention-card 
          [intervention]="inter"
          [statusConfig]="STATUS_CONFIG"
          (deleteClick)="deleteIntervention($event)"
          [canDelete]="authService.hasPerm('dash_act_delete')"
          [canEdit]="true"
          (editClick)="goToEdit(inter)"
          (cardClick)="inter.status === 'END' ? goToInvoice(inter) : (authService.hasPerm('dash_nav_billed') ? markAsPaid(inter, $event) : null)"
          (actionClick)="inter.status === 'END' ? router.navigate(['/history', inter.id]) : null"
          (callOwner)="makeCall($event)">
        </app-intervention-card>
        }
      </div>
    </section>
    }

    @if (filteredInterventions().length === 0) {
    <div class="empty-state">
      <p>Aucune intervention trouvée</p>
    </div>
    }
    }
  </main>

  <app-bottom-nav></app-bottom-nav>

  @if (selectedIntervention()) {
  <app-task-modal 
  [intervention]="selectedIntervention()!" 
  (close)="selectedIntervention.set(null)"
  (callRequest)="makeCall($event)">

  </app-task-modal>
  }
</div>